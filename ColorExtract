<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è‰²ã”ã¨æŠ½å‡ºãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ„ãƒ¼ãƒ«</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 2em; }
  input[type="text"] { margin: 0.2em; width: 90px; text-align: center; }
  canvas { margin: 0.5em; border: 1px solid #ccc; image-rendering: pixelated; }
  .layer { display: inline-block; margin: 1em; }
</style>
</head>
<body>
<h2>ğŸ¨ è‰²ã”ã¨æŠ½å‡ºãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ„ãƒ¼ãƒ«ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼‰</h2>

<p>1ï¸âƒ£ ç”»åƒã‚’é¸æŠï¼š</p>
<input type="file" id="fileInput" accept="image/*"><br>

<p>2ï¸âƒ£ æŠ½å‡ºã—ãŸã„ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆè¤‡æ•°OKï¼‰</p>
<div id="colorInputs">
  <input type="text" value="#FDEBA4">
  <input type="text" value="#F6D65F">
  <input type="text" value="#F3B500">
  <input type="text" value="#987000">
</div>
<button id="addColor">ï¼‹ã‚«ãƒ©ãƒ¼è¿½åŠ </button><br><br>

<button id="processBtn">ç”»åƒã‚’æŠ½å‡º</button>

<div id="results"></div>

<script>
const fileInput = document.getElementById("fileInput");
const processBtn = document.getElementById("processBtn");
const addColorBtn = document.getElementById("addColor");
const colorInputs = document.getElementById("colorInputs");
const results = document.getElementById("results");
let img = new Image();

// ç”»åƒèª­ã¿è¾¼ã¿
fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
});

// ã‚«ãƒ©ãƒ¼è¿½åŠ 
addColorBtn.addEventListener("click", () => {
  const input = document.createElement("input");
  input.type = "text";
  input.value = "#000000";
  colorInputs.appendChild(input);
});

// HEX â†’ RGB
function hexToRGB(hex) {
  hex = hex.replace("#", "");
  if (hex.length === 3) hex = hex.split("").map(c => c + c).join("");
  const bigint = parseInt(hex, 16);
  return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
}

// æŠ½å‡ºå‡¦ç†
processBtn.addEventListener("click", () => {
  if (!img.src) return alert("å…ˆã«ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
  results.innerHTML = "";
  
  const tmpCanvas = document.createElement("canvas");
  const ctx = tmpCanvas.getContext("2d");
  tmpCanvas.width = img.width;
  tmpCanvas.height = img.height;
  ctx.drawImage(img, 0, 0);
  const baseData = ctx.getImageData(0, 0, tmpCanvas.width, tmpCanvas.height);

  const colors = Array.from(colorInputs.querySelectorAll("input")).map(i => i.value);

  colors.forEach(hex => {
    const [tr, tg, tb] = hexToRGB(hex);
    const newData = new ImageData(tmpCanvas.width, tmpCanvas.height);

    for (let i = 0; i < baseData.data.length; i += 4) {
      const [r, g, b, a] = baseData.data.slice(i, i + 4);
      if (r === tr && g === tg && b === tb && a > 0) {
        newData.data[i] = r;
        newData.data[i + 1] = g;
        newData.data[i + 2] = b;
        newData.data[i + 3] = 255; // ä¸é€æ˜
      } else {
        newData.data[i] = 0;
        newData.data[i + 1] = 0;
        newData.data[i + 2] = 0;
        newData.data[i + 3] = 0; // é€é
      }
    }

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼Canvasç”Ÿæˆ
    const layerCanvas = document.createElement("canvas");
    const layerCtx = layerCanvas.getContext("2d");
    layerCanvas.width = img.width;
    layerCanvas.height = img.height;
    layerCtx.putImageData(newData, 0, 0);

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨DLãƒœã‚¿ãƒ³
    const div = document.createElement("div");
    div.className = "layer";
    div.innerHTML = `<p>${hex}</p>`;
    div.appendChild(layerCanvas);

    const dl = document.createElement("button");
    dl.textContent = "ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
    dl.addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = `layer_${hex.replace("#","")}.png`;
      link.href = layerCanvas.toDataURL("image/png");
      link.click();
    });
    div.appendChild(dl);
    results.appendChild(div);
  });
});
</script>
</body>
</html>
